# Аудио- и видеозвонок в чат

**Акторы:** авторизованные пользователи, приложение.

**Цель:** пользователь совершает аудио- или видеозвонок с группой авторизованных пользователей.

**Предусловия:** у авторизованного пользователя открыт групповой чат в который он хочет совершить аудио- или видеозвонок.

**Сценарий:**
1. Пользователь открывает меню для выбора типа звонка.
2. Приложение предлагает выбрать тип звонка: аудиозвонок или видеозвонок.
3. Пользователь выбирает аудиозвонок.

Пользователь может [совершить видеозвонок](#Совершение_видеозвонка).

4. Приложение отправляет запрос на совершение аудиозвонка группе пользователей, которые состоят в чате.
5. Приложение ждет ответа от пользователей, которым звонят (30 сек).
6. Приложение получает ответ от (хотя бы одного) пользователя, которые состоит в чате.

Приложение получает ответ ["Пользователи не отвечают"](#Пользователи_не_отвечают).

7. Приложение отправляет запрос на совершение аудиозвонка.
8. Приложение просит пользователей включить микрофон.
9. Приложение открывает соединение (канал связи) для предачи данных в цифровом виде, используя протокол IP.

{Успешное создание аудиозвонка}

10. Приложение возвращает ответ успешного совершения звонка.
11. Приложение открывает окно вызова.
12. Приложение начинает обмен данными по протоколу UDP/IP, передавая аудиоданные (и видеоданные в случае выбора видеозвонка).

{Продолжении конференции}

13. Приложение уведомлеят пользователя о новых подключении к конференции (звонку) других пользователей.
14. Один из пользователь завершает звонок.
15. Приложение посылает запрос на завершение звонка.

Приложение получает ответ ["Более двух активных пользователей"](#Более_двух_активных_пользователей)

16. Приложение возвращает ответ успешного завершения звонка.
17. Приложение закрывает окно вызова.
18. Приложение сохраняет данные о звонке в БД (никнеймы пользователей, длительность, дата и время начала разговора, дата и время конца разговора).
19. Приложение уведомляет пользователей о совершенном звонке (длительность, дата и время начала разговора, дата и время конца разговора).


**Результат:**
* Пользователь успешно совершил аудио- или видеозвонок в чат.
* В групповом чате отображается время начала, конца и длительность разговора.

**Исключения:**
1. Если ни один пользователь из чата не отвечает 30 секунд приложение возвращает ошибку "Пользователи не отвечают".


**Альтернативный сценарий:**

3а. <a name="Совершение_видеозвонка"></a> *Совершение видеозвонка*.  

3а1. Приложение отправляет запрос на совершение видеозвонка группе пользователей, которые состоят в чате.  
3а2. Приложение ждет ответа от пользователей, которым звонят (30 сек).  
3а3. Приложение получает ответ от (хотя бы одного) пользователя, которые состоит в чате.  

Приложение получает ответ ["Пользователи не отвечают"](#Пользователи_не_отвечают).  

3а4. Приложение отправляет запрос на совершение видеозвонка.  
3а5. Приложение просит пользователей включить микрофон и камеру.  
3а6. Приложение открывает соединение (канал связи) для предачи данных в цифровом виде, используя протокол IP.  

Возврат на шаг 10 {Успешное завершение аудиозвонка}.


6а. <a name="Пользователи_не_отвечают"></a> *Пользователи не отвечают*.  

6а1. Приложение уведомляет пользователя о неуспешной попытке аудио- (или видео-) звонка.  
6а2. Приложение сохраняет данные о неуспешной попытке звонка в БД (никнеймы пользователей, дата и время звонка).   
6а2. Приложение уведомляет всех пользоватлей из чата о неуспешной попытке звонка от пользователя, который звонил.  

15а. <a name="Более_двух_активных_пользователей"></a> *Более двух активных пользователей.*

15а1. Приложение отправляет активным пользователем уведомление об отключении пользователя от конференции.  
15а2. Приложение закрывает окно вызова пользователю, который завершил звонок.

Возврат на шаг 13 {Продолжение конференции}.

![activity_for_group_call](http://polinanov.mati.su/svg/activity.png "Диаграмма activity")

![sequence_for_personal_call](http://www.plantuml.com/plantuml/png/lP91QiCm44NtEiMGLGBD1R8eCRr0IUawJEK95PKbLJDAoUshIKgb1Yy2XVo53DRt_y_IR5amIvcyuGyN4cQSWEcpKB3qN7USTGc3G0aZPUy26ODMOePNfcpUOdsF-GIB8INlB8gBOG78C1YZ3bW_mh215_9aPI-dH7kBtYzNckAEAAJE0TRLT_PlO4TISbYgTsL6wdrzv4uXMURY37e1BjOIyw5uiCXae6gs9vVQexj_kg2gQtlIbekjcQuoRudqCIRGVJ3m8uNDn2a69f2l2ALcSODMNTF4ANcItxE4JdrXqnpc0JrJ-tYMLqNLrWZZ0QQO2UGTmrrn9PURQCDe-cS_XNYaVPkB2qx0YHv0dAvZoUS9_kT5dm-iX5idiBk7FWPcyKkumm-0okW9RkjI9lyD  "Диаграмма sequence")

