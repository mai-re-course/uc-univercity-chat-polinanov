# Аудио- и видеозвонок пользователю

**Акторы:** авторизованные пользователи, приложение.

**Цель:** пользователь совершает аудио- или видеозвонок с другим авторизованным пользователем, чтобы пообщаться с ним напрямую.

**Предусловия:** у авторизованного пользователя открыт чат с конкретным авторизованным пользователем, к которому он хочет совершить аудио- или видеозвонок.

**Сценарий:**
1. Пользователь открывает меню для выбора типа звонка.
2. Приложение предлагает выбрать тип звонка: аудиозвонок или видеозвонок.
3. Пользователь выбирает аудиозвонок.

Пользователь может [совершить видеозвонок](#Совершение_видеозвонка).

4. Приложение отправляет запрос на совершение аудиозвонка пользователю, которому звонят.
5. Приложение ждет ответа от пользователя, которому звонят (30 сек).
6. Приложение получает ответ от пользователя, которому звонят.

Приложение получает ответ ["Пользователь не отвечает" (или "Пользователь занят" или "Пользователь разговаривает")](#Пользователь_не_отвечает) от пользователя, которому звонят.

7. Приложение отправляет запрос на совершение аудиозвонка.
8. Приложение просит пользователя включить микрофон.
9. Приложение открывает соединение (канал связи) для предачи данных в цифровом виде, используя протокол IP.

{Успешное создание аудиозвонка}

10. Приложение возвращает ответ успешного совершения звонка.
11. Приложение открывает окно вызова.
12. Приложение начинает обмен данными по протоколу UDP/IP, передавая аудиоданные (и видеоданные в случае выбора видеозвонка).
13. Один из пользователей завершает звонок.
14. Приложение возвращает ответ успешного завершения звонка.
15. Приложение сохраняет данные о звонке в БД (никнеймы пользователей, длительность, дата и время начала разговора, дата и время конца разговора).

**Результат:**
* Пользователь успешно совершил аудио- или видеозвонок с другим пользователем.
* В персональном чате отображается время начала, конца и длительность разговора.

**Исключения:**
1. Если пользователь не отвечает 30 секунд "Пользователь не отвечает".
2. Если пользователь сбрасывает звонок показывается ошибка "Пользователь занят".
3. Если пользователь в данный момент совершает аудио- или видеозвонок другому пользователю в системе показывается ошибка "Пользователь разговаривает".


**Альтернативный сценарий:**

3а. <a name="Совершение_видеозвонка"></a> *Совершение видеозвонка*.

3а1. Приложение отправляет запрос на совершение видеоозвонка пользователю, которому звонят.
3а2. Приложение ждет ответа от пользователя, которому звонят (30 сек).
3а3. Приложение получает ответ от пользователя, которому звонят.
3а4. Приложение отправляет в бекенд запрос на совершение видеозвонка.
3а5. Приложение просит пользователя включить микрофон и камеру.
3а6. Приложение открывает соединение (канал связи) для предачи данных в цифровом виде, используя протокол IP.

Возврат на шаг 10 {Успешное завершение аудиозвонка}.



6а. <a name="Пользователь_не_отвечает"></a> *Пользователь не отвечает (или "Пользователь занят" или "Пользователь разговаривает")*.

6а1. Приложение возвращает ответ ("Пользователь не отвечает", "Пользователь занят", "Пользователь разговаривает") и уведомляет пользователя о неуспешной попытке аудио- (или видео-) звонка.
6а2. Приложение сохраняет данные о неуспешной попытке звонка в БД (никнеймы пользователей, дата и время звонка).
6а2. Приложение уведомляет пользователя, которому звонят о неуспешной попытке звонка от пользователя, который звонил.

